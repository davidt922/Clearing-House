<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures Market</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">


    <!-- Load Web3 script to link html with blockchain -->
    <script src="./node_modules/web3/dist/web3.min.js"></script>

    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  </head>

  <body>
    <div id="content">
      <div class="main">
        <h1>Send Ejecution to CCP</h1>
        <label for="name" class="col-lg-2 control-label">ISIN:</label>
        <br>
        <input id="ISIN" type="text">
        <br>
        <br>
        <label for="name" class="col-lg-2 control-label">Volume:</label>
        <br>
        <input id="volume" type="text">
        <br>
        <br>
        <label for="name" class="col-lg-2 control-label">Maturity date:</label>
        <br>
        <input id="maturityDate" type="datetime-local">
        <br>
        <br>
        <label for="name" class="col-lg-2 control-label">Currency:</label>
        <br>
        <input id="currency" type="text">
        <br>
        <br>
        <button id="button">Send Ejecution</button>
      </div>
      <div class="side" style="background-color:blue"></div>
      <div id="connection"></div>
    </div>
    <div id="lastContract"></div>
    <div id="trade">
      <div id="buy"></div>
      <div id="sell"></div>
    </div>
    <script>
  //  const fs = require('fs');
  //  const solc = require('solc');
  //  const Web3 = require('web3');
    /**
    * We use Web3 to connect and interact with the blockchain using a web envoirment
    * First we need to create a web3 instance, setting a provider `settying the ip-port where the testnet is located'
    */
    if (typeof web3 !== 'undefined')
    {
      web3 = new Web3(web3.currentProvider);
    }
    else
    {
      // Set the provider that we want from Web3.providers
      web3 = new Web3(new Web3.providers.HttpProvider("http://192.168.2.104:8545"));
    }
    /**
    * Check if the connection to the ethereum blockchin is done successfully
    */
    if (web3.isConnected() == true)
    {
      console.log("Ethereum connection successful");
      $("#connection").css("background-color","green");
    }
    else
    {
      console.log("Ethereum connection unsuccessful");
      $("#connection").css("background-color","red");
    }

    var stringDefaultAccount = "0";/*prompt("Enter default Account");*/
    var defaultAccount = parseInt(stringDefaultAccount);

    //Define the default eth account to use
    web3.eth.defaultAccount = web3.eth.accounts[0];

    var CCPContract = web3.eth.contract([{"constant": false,"inputs": [{"name": "_clearingMemberAddress","type": "address"}],"name": "addClearingMember","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [],"name": "getOwnerAccount","outputs": [{"name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [],"name": "getNextPaymentTime","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "_buyerAddress","type": "address"},{"name": "_sellerAddress","type": "address"},{"name": "_ISIN","type": "string"},{"name": "_currency","type": "string"},{"name": "_maturityDate","type": "uint256"},{"name": "_volume","type": "uint256"}],"name": "addFuture","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"constant": true,"inputs": [{"name": "","type": "uint256"}],"name": "clearingMemberArray","outputs": [{"name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": true,"inputs": [{"name": "","type": "address"}],"name": "clearingMemberMap","outputs": [{"name": "","type": "address"}],"payable": false,"stateMutability": "view","type": "function"},{"constant": false,"inputs": [{"name": "_marketAddress","type": "address"}],"name": "setMarketAddress","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},{"inputs": [],"payable": false,"stateMutability": "nonpayable","type": "constructor"},{"anonymous": false,"inputs": [{"indexed": false,"name": "_memberAddress","type": "address"}],"name": "clearingMemberInfo","type": "event"},{"anonymous": false,"inputs": [{"indexed": false,"name": "_futureId","type": "bytes32"}],"name": "addFutureInfo","type": "event"}]);

    var CCP = CCPContract.at('0x24f90706feae069c3cc15cff2d0bc86f1234b1a2');

    var contractDeployedEvent = CCP.clearingMemberInfo();

  // CCP.setMarketAddress(web3.eth.accounts[0]);

    contractDeployedEvent.watch(function(error, result)
    {
      if(!error)
      {
        $("#lastContract").html(result.args._memberAddress);
      }
      else
      {
          $("#lastContract").html("");
      }
    });
    console.log("Zero Account "+web3.eth.accounts[0]);
    console.log("Default account "+web3.eth.defaultAccount);
    console.log("Contract Owner account "+web3.eth.defaultAccount);
    CCP.addClearingMember(web3.eth.accounts[7]);
    $("#button").click(
      function()
      {
        var myDate = new Date($("#maturityDate").val());
        // COnvert to seconds
        myDate = myDate / 1000;
        console.log(myDate.valueOf());
        console.log(web3.eth.accounts[1].address);
        /*CCP.addFuture(web3.eth.accounts[1], web3.eth.accounts[2], $("#ISIN").val(), $("#currency").val(), myDate, $("#volume").val(), (err, res) =>{
          if (!err)
          {
            //$("#instructor").html("This address could not modify the smart contract");
            console.log("Future Added succesfully");
          }
          else
          {
              console.log("Error "+err);
          }
        }
      );
      */
    //  CCP.addClearingMember(web3.eth.accounts[8]);
      /*CCP.addFuture("0x2352788228720ce86bca5c0429e3d9e51fbcbfb8", "0x2352788228720ce86bca5c0429e3d9e51fbcbfb8", "1234", "EUR", "1234", "22", (err, res) =>{
        if (!err)
        {
          //$("#instructor").html("This address could not modify the smart contract");
          console.log("Future Added succesfully");
        }
        else
        {
            console.log("Error "+err);
        }
      }
    );*/
      });
    </script>
  </body>
</html>
